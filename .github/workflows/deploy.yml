name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

env:
  SERVICE: PubliCar
  # REGION: # TODO
  # PROJECT_ID: # TODO
  DOCKERHUB_USERNAME: paulooo
  IMAGE_NAME: publicar-backend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # - name: Set up Google Cloud
      #   uses: google-github-actions/auth@v2
      #   with:
      #     credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract commit SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push images
        run: |
          SHA_TAG=${{ steps.vars.outputs.sha_short }}
          DH_IMAGE=${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          GCR_IMAGE=gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE_NAME }}

          docker build -t $DH_IMAGE:$SHA_TAG -t $DH_IMAGE:latest .

          # build with gcr
          # docker build -t $DH_IMAGE:$SHA_TAG -t $DH_IMAGE:latest -t $GCR_IMAGE:$SHA_TAG -t $GCR_IMAGE:latest .

          docker push $DH_IMAGE:$SHA_TAG
          docker push $DH_IMAGE:latest

          # docker push $GCR_IMAGE:$SHA_TAG
          # docker push $GCR_IMAGE:latest

      # - name: Deploy to Cloud Run
      #   uses: google-github-actions/deploy-cloudrun@v2
      #   with:
      #     service: ${{ env.SERVICE }}
      #     region: ${{ env.REGION }}
      #     image: gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}
