# PubliCar Backend

A Go-based backend service for the PubliCar application.

## Prerequisites

### Install SQLC:
```bash
go install github.com/sqlc-dev/sqlc/cmd/sqlc@v1.29.0
```

## Quick Start

1. **Setup environment variables:**
   ```bash
   cp .env.example .env
   # Edit .env with your database configuration
   ```

2. **Start the development environment:**
   ```bash
   make run
   ```

3. **Run database migrations:**
   ```bash
   make migrate-up
   ```

## Database Migrations

This project uses [golang-migrate](https://github.com/golang-migrate/migrate) for database migrations.

### Development Environment

```bash
# Apply all pending migrations
make migrate-up

# Rollback all migrations
make migrate-down

# Check current migration version
make migrate-version

# Create a new migration
make migrate-create NAME=add_new_table

# Force migration to specific version (use with caution)
make migrate-force VERSION=1
```

### Production Environment

For production databases, use the production commands:

```bash
# Set your production database URL
export PROD_DB_URL="postgres://user:password@host:port/dbname?sslmode=require"

# Apply migrations to production
make migrate-up-prod

# Check production migration version
make migrate-version-prod

# Rollback production migrations (use with extreme caution)
make migrate-down-prod
```

### Development Workflow

```bash
# Complete development setup (starts containers + runs migrations)
make dev-setup

# Reset database and reapply all migrations
make dev-reset
```

## Available Commands

Run `make help` to see all available commands.

### Development Commands
- `make run` - Start development environment
- `make run-detached` - Start development environment in background
- `make stop` - Stop development environment
- `make db` - Connect to database

### Migration Commands
- `make migrate-up` - Apply all pending migrations
- `make migrate-down` - Rollback all migrations
- `make migrate-version` - Show current migration version
- `make migrate-create NAME=name` - Create new migration
- `make migrate-force VERSION=X` - Force migration to specific version

### Production Commands
- `make migrate-up-prod` - Apply migrations to production (PROD_DB_URL required)
- `make migrate-down-prod` - Rollback production migrations
- `make migrate-version-prod` - Show production migration version

### Code Generation
- `make sqlc` - Generate SQL code from queries

## Project Structure

```
├── cmd/server/          # Application entry point
├── internal/            # Internal application code
│   ├── db/             # Database layer (generated by sqlc)
│   ├── handler/        # HTTP handlers
│   └── router/         # HTTP router
├── db/                 # Database schema and migrations
│   ├── migrations/     # Database migration files
│   ├── queries/        # SQL queries for sqlc
│   └── schema.sql      # Database schema
└── scripts/            # Utility scripts
```

## Database Schema

The application uses PostgreSQL with the following main tables:
- `users` - User accounts (drivers and admins)
- `companies` - Company information
- `company_driver_bindings` - Driver-company relationships
- `trips` - Trip records
- `trip_locations` - GPS locations during trips
- `payments` - Payment records
- `trip_photo_metadata` - Photo metadata for trips
